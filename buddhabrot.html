<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>ü•¶</title>
    <link rel="icon" href="s-l1200.ico" type="image/x-icon">
    <style>
        html,
        body {
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #000;
            overflow: hidden;
        }

        #buddhabrot {
            background: #000;
            box-shadow: 0 0 64px #000 inset;
            /* 1) Siempre cuadrado seg√∫n el menor de ancho/alto */
            width: 100vmin;
            height: 100vmin;
            display: block;
        }

        #loading {
            /* ‚Ä¶igual que antes‚Ä¶ */
            position: fixed;
            z-index: 10;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #000;
            color: #fff;
            font-family: 'Noto Sans', Arial, sans-serif;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            background: #000;
            font-size: 3vw;
            font-variant-numeric: tabular-nums;
            text-shadow: 0 0 32px #fff, 0 0 8px #ffc300;
            letter-spacing: 0.09em;
            transition: opacity 0.4s;
            pointer-events: none;
            user-select: none;
            opacity: 1;
        }

        #loading.hidden {
            opacity: 0;
            pointer-events: none;
            transition: opacity 1.2s;
        }
    </style>
</head>

<body>
    <div id="loading"></div>
    <canvas id="buddhabrot"></canvas>
    <script>
        function isMobile() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i
                .test(navigator.userAgent)
                || window.innerWidth < 700;
        }
        const resolutionScale = 2;
        function getCanvasSize() {
            const rawSizeCss = Math.min(window.innerWidth, window.innerHeight);
            const pixelRatio = window.devicePixelRatio || 1;
            let size = Math.floor(rawSizeCss * pixelRatio * resolutionScale);
            const maxDim = isMobile() ? 2048 : 4096;
            if (size > maxDim) size = maxDim;
            return { size, rawSizeCss };
        }

        function colorGrad(val) {
            if (val < 0.20) {
                let t = val / 0.20;
                return [0 + t * 60, 0 + t * 100, 0 + t * 255];
            } else if (val < 0.45) {
                let t = (val - 0.20) / 0.25;
                return [60 + t * 195, 100 + t * 155, 255];
            } else if (val < 0.80) {
                let t = (val - 0.45) / 0.35;
                return [255, 255, 255 - t * 192];
            } else {
                let t = (val - 0.80) / 0.20;
                return [255, 255 - t * 255, 63 - t * 63];
            }
        }
        function getComplexPlane(size) {
            let reMin = -2, reMax = 1;
            // Calcula el centro y el span para centrar el Buda y evitar el corte abajo
            let imCenter = 0.05;  // centro vertical t√≠pico del buddhabrot
            let imSpan = reMax - reMin;
            let imMin = imCenter - imSpan / 2;
            let imMax = imCenter + imSpan / 2;
            return { reMin, reMax, imMin, imMax };
        }
        function showLoading(percent) {
            const loader = document.getElementById("loading");
            loader.textContent = percent === undefined ? "" : `${percent}%`;
            loader.classList.remove("hidden");
            loader.style.display = 'flex';
        }
        function hideLoading() {
            const loader = document.getElementById("loading");
            loader.classList.add("hidden");
            setTimeout(() => loader.style.display = 'none', 1200);
        }

        let rendering = false;

        function startBuddhabrot() {
            rendering = true;
            const { size } = getCanvasSize();
            const canvas = document.getElementById('buddhabrot');
            canvas.width = canvas.height = size;
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, size, size);

            const plane = getComplexPlane();
            const maxIter = isMobile() ? 1200 : 3000;          // m√°s iteraciones
            const muestras = Math.floor(size * size * (isMobile() ? 0.35 : 1.5)); // m√°s samples
            const bailout = 4;
            const minIter = 10;
            let acc = new Uint32Array(size * size);
            let done = 0;
            const batches = 200;
            const batchSize = Math.floor(muestras / batches);

            function paso() {
                for (let i = 0; i < batchSize && done < muestras; i++, done++) {
                    let z_re = 0, z_im = 0;
                    let zs = [];
                    const c_re = Math.random() * (plane.reMax - plane.reMin) + plane.reMin;
                    const c_im = Math.random() * (plane.imMax - plane.imMin) + plane.imMin;
                    let iter = 0, esc = false;
                    while (iter < maxIter) {
                        zs.push([z_re, z_im]);
                        const nr = z_re * z_re - z_im * z_im + c_re;
                        const ni = 2 * z_re * z_im + c_im;
                        z_re = nr; z_im = ni;
                        if (z_re * z_re + z_im * z_im > bailout) {
                            esc = true; break;
                        }
                        iter++;
                    }
                    if (esc && iter > minIter) {
                        // 2) mapping CORRECTO: real‚ÜíX, imag‚ÜíY invertida
                        for (const [zr, zi] of zs) {
                            const y = Math.floor((zr - plane.reMin) / (plane.reMax - plane.reMin) * size);
                            const x = size - 1 - Math.floor((zi - plane.imMin) / (plane.imMax - plane.imMin) * size);
                            if (x >= 0 && x < size && y >= 0 && y < size) {
                                acc[y * size + x]++;
                            }
                        }
                    }
                }
                showLoading(Math.round(done / muestras * 100));
                if (done < muestras && rendering) {
                    setTimeout(paso, 1);
                } else {
                    renderizar(acc, ctx, size);
                }
            }
            paso();
        }

        function renderizar(acc, ctx, size) {
            showLoading(100);
            setTimeout(() => {
                // 3) Normaliza + gamma
                let maxA = acc.reduce((a, v) => v > a ? v : a, 1);
                const img = ctx.createImageData(size, size);
                for (let y = 0; y < size; y++) {
                    for (let x = 0; x < size; x++) {
                        const i = (y * size + x) * 4;
                        const v = acc[y * size + x];
                        let n = v ? Math.log(v) / Math.log(maxA) : 0;
                        n = Math.pow(n, 0.6);  // gamma
                        const [r, g, b] = colorGrad(n);
                        img.data[i] = r;
                        img.data[i + 1] = g;
                        img.data[i + 2] = b;
                        img.data[i + 3] = Math.max(110, 255 * n);
                    }
                }
                // 4) pinta base
                ctx.putImageData(img, 0, 0);

                // 5) Bloom para halo suave
                const buf = document.createElement('canvas');
                buf.width = buf.height = size;
                buf.getContext('2d').putImageData(img, 0, 0);
                ctx.save();
                ctx.globalAlpha = 0.12;
                ctx.filter = 'blur(6px)';
                ctx.drawImage(buf, 0, 0);
                ctx.restore();

                rendering = false;
                hideLoading();
            }, 10);
        }

        // Arranca
        function renderPage() {
            showLoading(0);
            startBuddhabrot();
        }
        window.addEventListener('DOMContentLoaded', renderPage);
        window.addEventListener('resize', () => {
            if (window._t) clearTimeout(window._t);
            window._t = setTimeout(renderPage, 1200);
        });
    </script>
</body>

</html>